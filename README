================================================================================
XPapers: A subject repository and virtual research environment platform
================================================================================

ABOUT THIS RELEASE (1.0-experimental)

This is an experimental release of xPapers. This should not even be considered beta yet. A more stable, easier to use, better documented version is coming soon. 

LEGAL

xPapers is (c)opyright David Bourget 2006-2010 and the University of London 2009-2010. 

xPapers is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License version 3 as published by the Free Software Foundation. See http://www.gnu.org/licenses/ for a copy of the license.  

xPapers is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. 

SPONSOR

This software has been developed with the financial support of the Join Information Systems Committee (JISC) as part of the Information Environment Programme (PhilPapers 2.0 project). For more information on JISC's programmes, see http://www.jisc.ac.uk.

AUTHORS & PARTICIPANTS

David Bourget (lead developer)
Zbigniew Lukasiak (developer)
David Chalmers (scientific expert)

FOR MORE INFORMATION

Project's web site at http://xpapers.org
Github page at https://github.com/xPapers/xPapers



SYSTEM REQUIREMENTS
===================

xPapers should run fine on any Linux-based system. It may also work in a Cygwin environment on Windows, but this has not been tested. 

Hardware-wise, it all depends on the amount of traffic you have to support. At the time of writing PhilPapers.org runs on an 8-core machine with 32GB of ram. We comfortably serve about 300K visitors per month with this hardware. As a rule of thumb, plan to have one resident fastcgi handler per concurrent non-static request you have to handle. Each resident process consumes about 150MB of ram and should have about half a CPU. Try also to have enough ram to fit all your data so the MySQL database files are always fully cached. For example, the PhilPapers database currently has 10GB and we want to support about 20 concurrent dynamic requests, so we should plan a minimum of 13GB just for xPapers. In addition, we need to have a lot of free RAM for some RAM-hungry maintenance processes like the automated classifier (at least 8GB). We'd probably be fine with 24GB, but we got 32 to be safe. 


INSTALLATION INSTRUCTIONS
=========================

With a bit of luck, you should be able to get xPapers going in little time by following these instructions to the letter on a brand new Debian or Ubuntu system. Installing on a RHEL-style system will require that you do a bit of research to find the RPM packages that correspond to the deb packages used here. These instructions assume that you don't have any of the external dependencies (e.g. MySQL, Apache) installed. Adjust as appropriate. 


APT dependencies
----------------

sudo apt-get install automake libtool libncurses5-dev g++ sysstat aspell libaspell-dev perl apache2 libapache2-mod-fastcgi git

Note: we need to install MySQL from source to compile it with Sphinx. If you have MySQL installed with your distribution's packaging system, you should preferably remove it. 


xPapers source
---------------

You may already have done this, but if not check out the xPapers distrib where you would like xpapers to live. We recommend that you set it up in /home/xpapers because that's the default directory we use in all the examples provided. Using this directory is going to make things significantly simpler for you. Also, it makes sense if you set up a separate xpapers user to run your cron jobs and all, which we also recommend. Let's assume you want to do this:

sudo adduser xpapers
[ answer the questions ]

While at it, we recommend adding yourself (or xpapers) to the www-data group for convenience. This will allow you to run the cron scripts and restart the xpapers processes. Edit /etc/group as required.

Now let's pull the xpapers code.

cd /home
sudo git clone git@github.com:xPapers/xPapers.git
(remove /home/xpapers if required: sudo rm -rf /home/xpapers)
sudo mv xPapers xpapers 
sudo chown -R DESIRED_USER xpapers

let's set an environment variable to the xPapers home directory for future reference:
$XPAPERS=/home/xpapers


MySQL and Sphinx
----------------

Download MySQL 5.1 or more, source distribution
Download Sphinx 1.10-beta or more

You have to build mysql, build sphinx, and re-build mysql, unfortunately.

Here are steps that work for us on Ubuntu:

MySQL, first time around:

(Everything here should be optional except the innobase plugin and the utf8 charset, both required by xPapers. However what follows assumes that you are using the same paths.)

cd [MySQL source dir]
sudo ./configure  --prefix=/usr/local/mysql --exec-prefix=/usr/local/mysql --with-charset=utf8 \
--with-mysqld-user=mysql --localstatedir=/var/lib/mysql --enable-assembler \ 
--with-unix-socket-path=/var/run/mysqld/mysqld.sock --with-plugins=innobase \
--sysconfdir=/usr/local/mysql/etc;sudo make;sudo make install

Then:

sudo groupadd mysql
sudo useradd -g mysql mysql
cd /usr/local/mysql
sudo chown -R mysql .
sudo chgrp -R mysql .
sudo bin/mysql_install_db --user=mysql
sudo chown -R root .
sudo chown -R mysql /var/lib/mysql
sudo cp share/mysql/my-medium.cnf /etc/my.cnf 
sudo cp share/mysql/mysql.server /etc/init.d/mysql
sudo update-rc.d mysql defaults 19
sudo ln -s /usr/local/mysql/bin/mysql /usr/bin/mysql
sudo ln -s /usr/local/mysql/bin/mysql_config /usr/bin/mysql_config

/usr/local/mysql/bin/mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root mysql #time zone data

sudo /etc/init.d/mysql start

You will want to customize the /etc/my.cnf configuration file. 

Sphinx:

cd [Sphinx source dir]
sudo ./configure --with-mysql=/usr/local/mysql --prefix=/usr/local/sphinx --exec-prefix=/usr/local/sphinx;
sudo make;sudo make install

MySQL with SphinxSE

cp -r [Sphinx source dir]/mysqlse [Mysql source dir]/storage/sphinx

cd [MySQL source dir]
sh BUILD/autorun.sh
sudo ./configure  --prefix=/usr/local/mysql --exec-prefix=/usr/local/mysql --with-charset=utf8 \
--with-mysqld-user=mysql --localstatedir=/var/lib/mysql --enable-assembler \ 
--with-unix-socket-path=/var/run/mysqld/mysqld.sock --with-plugins=sphinx,innobase \
--sysconfdir=/usr/local/mysql/etc;sudo make;sudo make install
sudo /etc/init.d/mysql restart

Now if you open the mysql client (sudo mysql) and do "show engines;" you should see the SPHINX engine. Consult the Sphinx documentation for more help.

While at it, create a MySQL user:
mysql>CREATE USER 'xpapers'@'localhost' IDENTIFIED BY 'some_pass';
mysql>GRANT ALL PRIVILEGES ON *.* TO 'xpapers'@'localhost';

You need to set up Sphinx's configuration. Our configuration file should work just fine if your XPAPERS directory is /home/xpapers:

sudo cp $XPAPERS/etc/sphinx.conf /usr/local/sphinx/etc/
Then change the database connection details in that file.

Then build your first index:

sudo /usr/local/sphinx/bin/indexer --all 


Perl modules
------------

Make sure cpan works.
# cpan
cpan> o conf init
[ choose to do everything automatically ]

cd $XPAPERS
sudo perl -Ilib bin/setup/cpan.pl assets/conf/dependencies.txt

IMPORTANT: The Algorithm::SVM package has been broken for a long time and may require manual intervention to install. If the installation fails, follow the instructions found on RT here: https://rt.cpan.org/Public/Bug/Display.html?id=43669  Once you've done that, run the cpan.pl script again, it will pick up where it left.

The default answers to all questions should be fine. 


Bibutils
--------

A binary distribution of bibutils is in $XPAPERS/bin/bibutils by default. If you are not on 64 bit Linux you will need to recompile these programs from source. Just uncompress the tarball provided in $XPAPERS/src and follow the instructions inside. Then copy or link the resulting executables on top of those in $XPAPERS/bin/bibutils. Bibutils is required for some bibliographic file import/export options.


Tweak your xPapers configuration
--------------------------------

Copy $XPAPERS/etc/xpapers.d to /etc/
Then adapt /etc/xpapers.d/main.pl to your needs. You should at least change the database settings and the $SUBJECT variable before proceeding to the next step. The rest can be adjusted later. There are more configuration variables available than this. For a complete list, check the documentation of the xPapers::Conf and xPapers::Conf::* packages. Each variable in these packages can be overriden by a variable under /etc/xpapers.d/


Initialize your database and xpapers subdirectories
---------------------------------------------------

cd $XPAPERS
perl -Ilib bin/setup/init-database.pl
sudo perl -Ilib bin/setup/mkdirs.pl
sudo perl -Ilib bin/setup/compileyui.pl


Apache configuration
--------------------

Use $XPAPERS/etc/apache2 as an example set of Apache configuration files. The important (xPapers-specific) files are mason.conf, sites-enabled/default-site, and mods-enabled/fastcgi*. Adapt to your needs. You should change the admin email, domain name, etc, but this default config should work out of the box. 

You also need to set up the xpapers init script: 

sudo cp $XPAPERS/bin/start /etc/init.d/xpapers
sudo update-rc.d xpapers defaults 21 

Now this script will start apache2, so we need to remove apache2:
sudo update-rc.d -f apache2 remove

**You should always control apache2 through /etc/init.d/xpapers or your memory cache may become corrupt **

The xpapers init script also controls Sphinx for convenience.  It assumes the paths used here, so you may have to modify it if you are using other paths. Now try it:

sudo /etc/init.d/xpapers restart

You might see a warning about Sphinx not running, that's OK.

Now try your new xPapers site with a web browser (http://localhost, or whatever you domain name is).


Sign up for external services
------------------------------

xPapers is configured to connect up with several external services:

- reCAPTCHA (necessary): you need to get reCAPTCHA credentials and save them in /etc/xpapers.d/main.pl
- Facebook (option): unless you want to unplug the Facebook option in the Followers module, register your app and input your credentials in /etc/xpapers.d/main.pl
- Amazon Affiliate: unlesss you plan to turn off Amazon links, register yourself as an affiliate on the US, UK and CA sites (the only three supported for now) and register your credentials in /etc/xpapers.d/main.pl

Set up your cron tasks 
----------------------

A large number of tasks are accomplished through cron scripts, including periodic re-building of the Sphinx index for search.  There is sample crontab in $XPAPERS/etc/contrab.example. Not all the services are necessary, but many are. The example includes all required tasks but Sphinx re-indexing. This is done as follows:

$SPHINX/bin/indexer --all --rotate

